# 16.ğŸ”¥åŸç†ç¯‡â€”äº‹ä»¶åŸç†ï¼ˆv18æ–°ç‰ˆæœ¬ï¼‰

## ä¸€ å‰è¨€

åœ¨ä¸Šä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°äº†è€ç‰ˆæœ¬çš„äº‹ä»¶åŸç†ï¼Œè€ç‰ˆæœ¬çš„äº‹ä»¶åŸç†æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œæ•è·é˜¶æ®µå’Œå†’æ³¡é˜¶æ®µçš„äº‹ä»¶éƒ½æ˜¯æ¨¡æ‹Ÿçš„ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨å†’æ³¡é˜¶æ®µæ‰§è¡Œçš„ï¼Œæ¯”å¦‚å¦‚ä¸‹ä¾‹å­ä¸­ï¼š

````js
function Index(){
    const refObj = React.useRef(null)
    useEffect(()=>{
        const handler = ()=>{
            console.log('äº‹ä»¶ç›‘å¬')
        }
        refObj.current.addEventListener('click',handler)
        return () => {
            refObj.current.removeEventListener('click',handler)
        }
    },[])
    const handleClick = ()=>{
       console.log('å†’æ³¡é˜¶æ®µæ‰§è¡Œ')
    }
    const handleCaptureClick = ()=>{
       console.log('æ•è·é˜¶æ®µæ‰§è¡Œ')
    }
    return  <button ref={refObj} onClick={handleClick} onClickCapture={handleCaptureClick} >ç‚¹å‡»</button>
}
````

å¦‚ä¸Šé€šè¿‡ onClickï¼ŒonClickCapture å’ŒåŸç”Ÿçš„ DOM ç›‘å¬å™¨ç»™å…ƒç´  button ç»‘å®šäº†ä¸‰ä¸ªäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œé‚£ä¹ˆå½“è§¦å‘ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶çš„æ—¶å€™ï¼Œå¤„ç†å‡½æ•°çš„æ‰§è¡Œï¼Œè€ç‰ˆæœ¬æ‰“å°é¡ºåºä¸ºï¼š

è€ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿï¼šäº‹ä»¶ç›‘å¬ -> æ•è·é˜¶æ®µæ‰§è¡Œ -> å†’æ³¡é˜¶æ®µæ‰§è¡Œ


ä½†æ˜¯è€ç‰ˆæœ¬çš„äº‹ä»¶ç³»ç»Ÿï¼Œä¸€å®šç¨‹åº¦ä¸Šï¼Œä¸ç¬¦åˆäº‹ä»¶æµçš„æ‰§è¡Œæ—¶æœºï¼Œä½†æ˜¯åœ¨æ–°ç‰ˆæœ¬ v18 çš„äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œè¿™ä¸ªé—®é¢˜å¾—ä»¥è§£å†³ã€‚

æ–°ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿï¼šæ•è·é˜¶æ®µæ‰§è¡Œ -> äº‹ä»¶ç›‘å¬ -> å†’æ³¡é˜¶æ®µæ‰§è¡Œ

é‚£ä¹ˆæ–°ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿæœ‰å“ªé‡Œæ”¹å˜å‘¢ï¼Ÿ æœ¬ç« èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ–°ç‰ˆæœ¬çš„äº‹ä»¶ç³»ç»ŸåŸç†ã€‚

å¯¹äº React äº‹ä»¶åŸç†æŒ–æ˜ï¼Œä¸»è¦ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼Œé‚£å°±æ˜¯**äº‹ä»¶ç»‘å®š**å’Œ**äº‹ä»¶è§¦å‘**ã€‚


## äºŒ äº‹ä»¶ç»‘å®šâ€”â€”äº‹ä»¶åˆå§‹åŒ–

åœ¨ React æ–°ç‰ˆçš„äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œåœ¨ createRoot ä¼šä¸€å£æ°”å‘å¤–å±‚å®¹å™¨ä¸Šæ³¨å†Œå®Œå…¨éƒ¨äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ç»†èŠ‚ï¼š


> react-dom/client.js
````js
function createRoot(container, options) {
    /* çœå»å’Œäº‹ä»¶æ— å…³çš„ä»£ç ï¼Œé€šè¿‡å¦‚ä¸‹æ–¹æ³•æ³¨å†Œäº‹ä»¶ */
    listenToAllSupportedEvents(rootContainerElement);
}
````
åœ¨ createRoot ä¸­ï¼Œé€šè¿‡ listenToAllSupportedEvents æ³¨å†Œäº‹ä»¶ï¼Œæ¥ä¸‹æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åšäº†äº›ä»€ä¹ˆï¼š

> react-dom/src/events/DOMPluginEventSystem.js
````js
function listenToAllSupportedEvents(rootContainerElement) {
    /* allNativeEvents æ˜¯ä¸€ä¸ª set é›†åˆï¼Œä¿å­˜äº†å¤§å¤šæ•°çš„æµè§ˆå™¨äº‹ä»¶ */
    allNativeEvents.forEach(function (domEventName) {
      if (domEventName !== 'selectionchange') {
         /* nonDelegatedEvents ä¿å­˜äº† js ä¸­ï¼Œä¸å†’æ³¡çš„äº‹ä»¶ */ 
        if (!nonDelegatedEvents.has(domEventName)) {
          /* åœ¨å†’æ³¡é˜¶æ®µç»‘å®šäº‹ä»¶ */ 
          listenToNativeEvent(domEventName, false, rootContainerElement);
        }
        /* åœ¨æ•è·é˜¶æ®µç»‘å®šäº‹ä»¶ */
        listenToNativeEvent(domEventName, true, rootContainerElement);
      }
    });
}
````
listenToAllSupportedEvents è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒæ ¸å¿ƒï¼Œä¸»è¦ç›®çš„å°±æ˜¯é€šè¿‡ listenToNativeEvent ç»‘å®šæµè§ˆå™¨äº‹ä»¶ï¼Œè¿™é‡Œå¼•å‡ºäº†ä¸¤ä¸ªå¸¸é‡ï¼ŒallNativeEvents å’Œ nonDelegatedEvents ï¼Œå®ƒä»¬åˆ†åˆ«ä»£è¡¨çš„æ„æ€å¦‚ä¸‹ï¼š

allNativeEventsï¼šallNativeEvents æ˜¯ä¸€ä¸ª set é›†åˆï¼Œä¿å­˜äº† 81 ä¸ªæµè§ˆå™¨å¸¸ç”¨äº‹ä»¶ã€‚
nonDelegatedEvents ï¼šè¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªé›†åˆï¼Œä¿å­˜äº†æµè§ˆå™¨ä¸­ä¸ä¼šå†’æ³¡çš„äº‹ä»¶ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯åª’ä½“äº‹ä»¶ï¼Œæ¯”å¦‚ pauseï¼Œplayï¼Œplaying ç­‰ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹æ®Šäº‹ä»¶ï¼Œæ¯”å¦‚ cancel ï¼Œcloseï¼Œinvalidï¼Œloadï¼Œscroll ã€‚

æ¥ä¸‹æ¥å¦‚æœäº‹ä»¶æ˜¯ä¸å†’æ³¡çš„ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œä¸€æ¬¡ï¼ŒlistenToNativeEventï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º true ã€‚
å¦‚æœæ˜¯å¸¸è§„çš„äº‹ä»¶ï¼Œé‚£ä¹ˆä¼šæ‰§è¡Œä¸¤æ¬¡ listenToNativeEventï¼Œåˆ†åˆ«åœ¨å†’æ³¡å’Œæ•è·é˜¶æ®µç»‘å®šäº‹ä»¶ã€‚

é‚£ä¹ˆ listenToNativeEvent å°±æ˜¯äº‹ä»¶ç›‘å¬ï¼Œè¿™ä¸ªå‡½æ•°è¿™é‡Œç»™å®ƒç²¾ç®€åŒ–ï¼ŒlistenToNativeEvent ä¸»è¦é€»è¾‘å¦‚ä¸‹

````js
var listener = dispatchEvent.bind(null,domEventName,...)
if(isCapturePhaseListener){
    target.addEventListener(eventType, dispatchEvent, true);
}else{
    target.addEventListener(eventType, dispatchEvent, false);
}
````
å¦‚ä¸Šä»£ç æ˜¯æºä»£ç ç²¾ç®€åçš„ï¼Œå¹¶ä¸æ˜¯æºç ï¼ŒisCapturePhaseListener å°±æ˜¯ listenToNativeEvent çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œtarget ä¸º DOM å¯¹è±¡ã€‚dispatchEvent ä¸ºç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬å‡½æ•°ã€‚

å¦‚ä¸Šå¯ä»¥çœ‹åˆ° listenToNativeEvent æœ¬è´¨ä¸Šå°±æ˜¯å‘åŸç”Ÿ DOM ä¸­å»æ³¨å†Œäº‹ä»¶ï¼Œä¸Šé¢è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯ dispatchEvent å·²ç»é€šè¿‡ bind çš„æ–¹å¼å°†äº‹ä»¶åç§°ç­‰ä¿¡æ¯ä¿å­˜ä¸‹æ¥äº†ã€‚ç»è¿‡è¿™ç¬¬ä¸€æ­¥ï¼Œåœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œå°±å·²ç»æ³¨å†Œäº†å¾ˆå¤šçš„äº‹ä»¶ç›‘å¬å™¨äº†ã€‚

æ­¤æ—¶å¦‚æœå‘ç”Ÿä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ï¼Œå°±ä¼šè§¦å‘ä¸¤æ¬¡ dispatchEvent ï¼š

* ç¬¬ä¸€æ¬¡æ•è·é˜¶æ®µçš„ç‚¹å‡»äº‹ä»¶ï¼›
* ç¬¬äºŒæ¬¡å†’æ³¡é˜¶æ®µçš„ç‚¹å‡»äº‹ä»¶ï¼›


## ä¸‰ äº‹ä»¶è§¦å‘

æ¥ä¸‹æ¥å°±æ˜¯é‡ç‚¹ï¼Œå½“è§¦å‘ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Œé¦–å…ˆå°±æ˜¯æ‰§è¡Œ dispatchEvent äº‹ä»¶ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°åšäº†äº›ä»€ä¹ˆï¼Ÿ

dispatchEvent ä¿ç•™æ ¸å¿ƒçš„ä»£ç å¦‚ä¸‹ï¼š
````js
batchedUpdates(function () {
    return dispatchEventsForPlugins(domEventName, eventSystemFlags, nativeEvent, ancestorInst);
});
````

dispatchEvent å¦‚æœæ˜¯æ­£å¸¸çš„äº‹ä»¶ï¼Œå°±ä¼šé€šè¿‡ batchedUpdates æ¥å¤„ç† dispatchEventsForPlugins ï¼ŒbatchedUpdates æ˜¯æ‰¹é‡æ›´æ–°çš„é€»è¾‘ï¼Œåœ¨ä¹‹å‰çš„ç« èŠ‚ä¸­å·²ç»è®²åˆ°é€šè¿‡è¿™ç§æ–¹å¼æ¥è®©æ›´æ–°å˜æˆå¯æ§çš„ã€‚æ‰€æœ‰çš„çŸ›å¤´éƒ½æŒ‡å‘äº† dispatchEventsForPlugins ï¼Œè¿™ä¸ªå‡½æ•°åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ

````js
function dispatchEventsForPlugins(domEventName, eventSystemFlags, nativeEvent, targetInst, targetContainer) {
  /* æ‰¾åˆ°å‘ç”Ÿäº‹ä»¶çš„å…ƒç´ â€”â€”äº‹ä»¶æº */  
  var nativeEventTarget = getEventTarget(nativeEvent);
  /* å¾…æ›´æ–°é˜Ÿåˆ— */
  var dispatchQueue = [];
  /* æ‰¾åˆ°å¾…æ‰§è¡Œçš„äº‹ä»¶ */
  extractEvents(dispatchQueue, domEventName, targetInst, nativeEvent, nativeEventTarget, eventSystemFlags);
  /* æ‰§è¡Œäº‹ä»¶ */
  processDispatchQueue(dispatchQueue, eventSystemFlags);
}
````
è¿™ä¸ªå‡½æ•°éå¸¸é‡è¦ï¼Œé¦–å…ˆé€šè¿‡ getEventTarget æ‰¾åˆ°å‘ç”Ÿäº‹ä»¶çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯äº‹ä»¶æºã€‚ç„¶ååˆ›å»ºä¸€ä¸ªå¾…æ›´æ–°çš„äº‹ä»¶é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—åšä»€ä¹ˆï¼Œé©¬ä¸Šä¼šè®²åˆ°ï¼Œæ¥ä¸‹æ¥é€šè¿‡ extractEvents æ‰¾åˆ°å¾…æ›´æ–°çš„äº‹ä»¶ï¼Œç„¶åé€šè¿‡ processDispatchQueue æ‰§è¡Œäº‹ä»¶ã€‚

ä¸Šé¢çš„ä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼Œæˆ‘ä»¬ä¼šé€ä¸€è¿›è¡Œè§£æï¼Œå…ˆä¸¾ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š


````js
function Index(){
    const handleClick = ()=>{
       console.log('å†’æ³¡é˜¶æ®µæ‰§è¡Œ')
    }
    const handleCaptureClick = ()=>{
       console.log('æ•è·é˜¶æ®µæ‰§è¡Œ')
    }
    const handleParentClick = () => {
        console.log('div ç‚¹å‡»äº‹ä»¶')
    }
    return  <div onClick={handleParentClick} >
        <button onClick={handleClick} onClickCapture={handleCaptureClick} >ç‚¹å‡»</button>
    </div>
}
````
å¦‚ä¸Šçš„ä¾‹å­ï¼Œæœ‰ä¸€ä¸ª div å’Œ button å‡ç»‘å®šäº†ä¸€ä¸ªæ­£å¸¸çš„ç‚¹å‡»äº‹ä»¶ ï¼Œdiv æ˜¯ button çš„çˆ¶å…ƒç´ ï¼Œé™¤æ­¤ä¹‹å¤– button ç»‘å®šäº†ä¸€ä¸ªåœ¨æ•è·é˜¶æ®µæ‰§è¡Œçš„ç‚¹å‡»äº‹ä»¶ã€‚

å½“ç‚¹å‡»æŒ‰é’®ï¼Œè§¦å‘ä¸€æ¬¡ç‚¹å‡»äº‹ä»¶çš„æ—¶å€™ï¼Œå¦‚æœ nativeEventTarget æœ¬è´¨ä¸Šå°±æ˜¯å‘ç”Ÿç‚¹å‡»äº‹ä»¶çš„ button å¯¹åº”çš„ DOM å…ƒç´ ã€‚

é‚£ä¹ˆç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ dispatchQueue æ˜¯ä»€ä¹ˆï¼Ÿ extractEvents æœ‰å¦‚ä½•å¤„ç†çš„ dispatchQueueã€‚

å‘ç”Ÿç‚¹å‡»äº‹ä»¶ï¼Œé€šè¿‡ä¸Šé¢æˆ‘ä»¬çŸ¥é“ï¼Œä¼šè§¦å‘ä¸¤æ¬¡ dispatchEventsï¼Œç¬¬ä¸€æ¬¡æ˜¯æ•è·é˜¶æ®µï¼Œç¬¬äºŒæ¬¡æ˜¯å†’æ³¡é˜¶æ®µ ï¼Œä¸¤æ¬¡æˆ‘ä»¬åˆ†åˆ«æ‰“å°ä¸€ä¸‹ dispatchQueue ï¼š

ç¬¬ä¸€æ¬¡æ‰“å°ï¼š


![1.png](./images/a5087c32b043467eb5525731692b4a24~tplv-k3u1fbpfcp-watermark.image.png)

ç¬¬ä¸€æ¬¡æ‰“å°ï¼š


![10-8-2.png](./images/20584f9179b24f9c8d9088b379d95f5b~tplv-k3u1fbpfcp-watermark.image.png)

å¦‚ä¸Šå¯ä»¥çœ‹åˆ°ä¸¤æ¬¡ dispatchQueue ä¸­åªæœ‰ä¸€é¡¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€æ¬¡ç”¨æˆ·ä¸­ï¼Œäº§ç”Ÿä¸€æ¬¡äº‹ä»¶å°±ä¼šå‘ dispatchQueue æ”¾å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡ä¸­æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼Œä¸€ä¸ªæ˜¯ event ï¼Œä¸€ä¸ªæ˜¯ listenersã€‚é‚£ä¹ˆè¿™ä¸¤ä¸ªä¸œè¥¿æ˜¯å¦‚ä½•æ¥çš„å‘¢ï¼Ÿ

event æ˜¯é€šè¿‡äº‹ä»¶æ’ä»¶åˆæˆçš„äº‹ä»¶æº eventï¼Œåœ¨ React äº‹ä»¶ç³»ç»Ÿä¸­ï¼Œäº‹ä»¶æºä¹Ÿä¸æ˜¯åŸç”Ÿçš„äº‹ä»¶æºï¼Œè€Œæ˜¯ React è‡ªå·±åˆ›å»ºçš„äº‹ä»¶æºå¯¹è±¡ã€‚å¯¹äºä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œä¼šåˆ›å»ºä¸åŒçš„äº‹ä»¶æºå¯¹è±¡ã€‚æœ¬è´¨ä¸Šæ˜¯åœ¨ extractEvents å‡½æ•°ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€æ®µå¤„ç†é€»è¾‘ã€‚

````js
 var SyntheticEventCtor = SyntheticEvent;
 /* é’ˆå¯¹ä¸åŒçš„äº‹ä»¶ï¼Œå¤„ç†ä¸åŒçš„äº‹ä»¶æº */
 switch (domEventName) {
    case 'keydown':
    case 'keyup':
      SyntheticEventCtor = SyntheticKeyboardEvent;
      break;
    case 'focusin':
      reactEventType = 'focus';
      SyntheticEventCtor = SyntheticFocusEvent;
      break;
    ....    
 }
/* æ‰¾åˆ°äº‹ä»¶ç›‘å¬è€…ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ onClick ç»‘å®šçš„äº‹ä»¶å¤„ç†å‡½æ•° */ 
var _listeners = accumulateSinglePhaseListeners(targetInst, reactName, nativeEvent.type, inCapturePhase, accumulateTargetOnly);
/* å‘ dispatchQueue æ·»åŠ  event å’Œ listeners  */
if(_listeners.length > 0){
    var _event = new SyntheticEventCtor(reactName, reactEventType, null, nativeEvent, nativeEventTarget);
    dispatchQueue.push({
        event: _event,
        listeners: _listeners
    });
}
````

å¦‚ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆæ ¹æ®ä¸åŒäº‹ä»¶ç±»å‹ï¼Œé€‰ç”¨ä¸åŒçš„æ„é€ å‡½æ•°ï¼Œé€šè¿‡ new çš„æ–¹å¼å»åˆæˆä¸åŒäº‹ä»¶æºå¯¹è±¡ã€‚ä¸Šé¢è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚å°±æ˜¯ _listeners æ˜¯ä»€ä¹ˆï¼Ÿ _listeners æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé‡Œé¢æœ‰ä¸‰ä¸ªå±æ€§ã€‚

currentTargetï¼šå‘ç”Ÿäº‹ä»¶çš„ DOM å…ƒç´ ã€‚
instance ï¼š button å¯¹åº”çš„ fiber å…ƒç´ ã€‚
listener ï¼šä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾ç»‘å®šçš„äº‹ä»¶å¤„ç†å‡½æ•°æœ¬èº«ï¼Œä¸Šé¢ demo ä¸­å°±æ˜¯ç»‘å®šç»™ onClickï¼ŒonClickCapture çš„å‡½æ•°ã€‚

æ¥ä¸‹æ¥å¯ä»¥é€šè¿‡ DOM å…ƒç´ æ‰¾åˆ°å¯¹åº”çš„ fiberï¼Œæ‰¾åˆ°å…ƒç´ å¯¹åº”çš„ fiber ä¹‹åï¼Œä¹Ÿå°±èƒ½æ‰¾åˆ° props äº‹ä»¶äº†ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯ listener å¯ä»¥æœ‰å¤šä¸ªï¼Œæ¯”å¦‚å¦‚ä¸Šæ•è·é˜¶æ®µçš„ listener åªæœ‰ä¸€ä¸ªï¼Œè€Œå†’æ³¡é˜¶æ®µçš„ listener æœ‰ä¸¤ä¸ªï¼Œè¿™æ˜¯å› ä¸º div button ä¸Šéƒ½æœ‰ onClick äº‹ä»¶ã€‚

å¦‚ä¸Šå¯ä»¥æ€»ç»“ä¸ºï¼š

**å½“å‘ç”Ÿä¸€æ¬¡ç‚¹å‡»äº‹ä»¶ï¼ŒReact ä¼šæ ¹æ®äº‹ä»¶æºå¯¹åº”çš„ fiber å¯¹è±¡ï¼Œæ ¹æ® returnæŒ‡é’ˆå‘ä¸Šéå†ï¼Œæ”¶é›†æ‰€æœ‰ç›¸åŒçš„äº‹ä»¶**ï¼Œæ¯”å¦‚æ˜¯ onClickï¼Œé‚£å°±æ”¶é›†çˆ¶çº§å…ƒç´ çš„æ‰€æœ‰  onClick äº‹ä»¶ï¼Œæ¯”å¦‚æ˜¯ onClickCaptureï¼Œé‚£å°±æ”¶é›†çˆ¶çº§çš„æ‰€æœ‰ onClickCaptureã€‚

å¾—åˆ°äº† dispatchQueue ä¹‹åï¼Œå°±éœ€è¦ processDispatchQueue æ‰§è¡Œäº‹ä»¶äº†ï¼Œè¿™ä¸ªå‡½æ•°çš„å†…éƒ¨ä¼šç»å†ä¸¤æ¬¡éå†ï¼š

* ç¬¬ä¸€æ¬¡éå† dispatchQueueï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œåªæœ‰ä¸€ä¸ªäº‹ä»¶ç±»å‹ï¼Œæ‰€æœ‰ dispatchQueue ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ ã€‚
* æ¥ä¸‹æ¥ä¼šéå†æ¯ä¸€ä¸ªå…ƒç´ çš„ listenerï¼Œæ‰§è¡Œ listener çš„æ—¶å€™æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼š

````js
/* å¦‚æœåœ¨æ•è·é˜¶æ®µæ‰§è¡Œã€‚ */
if (inCapturePhase) {
    for (var i = dispatchListeners.length - 1; i >= 0; i--) {
      var _dispatchListeners$i = dispatchListeners[i],
          instance = _dispatchListeners$i.instance,
          currentTarget = _dispatchListeners$i.currentTarget,
          listener = _dispatchListeners$i.listener;
     
      
      if (instance !== previousInstance && event.isPropagationStopped()) {
        return;
      }
      
      /* æ‰§è¡Œäº‹ä»¶ */
      executeDispatch(event, listener, currentTarget);
      previousInstance = instance;
    }
  } else {
    for (var _i = 0; _i < dispatchListeners.length; _i++) {
      var _dispatchListeners$_i = dispatchListeners[_i],
          _instance = _dispatchListeners$_i.instance,
          _currentTarget = _dispatchListeners$_i.currentTarget,
          _listener = _dispatchListeners$_i.listener;
      
      if (_instance !== previousInstance && event.isPropagationStopped()) {
        return;
      }
      /* æ‰§è¡Œäº‹ä»¶ */
      executeDispatch(event, _listener, _currentTarget);
      previousInstance = _instance;
    }
  }
````

å¦‚ä¸Šåœ¨ executeDispatch ä¼šè´Ÿè´£æ‰§è¡Œäº‹ä»¶å¤„ç†å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ handleClick ï¼ŒhandleParentClick ç­‰ã€‚è¿™ä¸ªæœ‰ä¸€ä¸ªåŒºåˆ«å°±æ˜¯ï¼Œå¦‚æœæ˜¯æ•è·é˜¶æ®µæ‰§è¡Œçš„å‡½æ•°ï¼Œé‚£ä¹ˆ listener æ•°ç»„ä¸­å‡½æ•°ï¼Œä¼šä»åå¾€å‰æ‰§è¡Œï¼Œå¦‚æœæ˜¯å†’æ³¡é˜¶æ®µæ‰§è¡Œçš„å‡½æ•°ï¼Œä¼šä»å‰å¾€åæ‰§è¡Œï¼Œç”¨è¿™ä¸ªæ¨¡æ‹Ÿå‡ºå†’æ³¡é˜¶æ®µå…ˆå­åçˆ¶ï¼Œæ•è·é˜¶æ®µå…ˆçˆ¶åå­ã€‚

è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚å°±æ˜¯å¦‚æœè§¦å‘äº†é˜»æ­¢å†’æ³¡äº‹ä»¶ï¼Œä¸Šè¿°è®²åˆ°äº‹ä»¶æºæ˜¯ React å†…éƒ¨è‡ªå·±åˆ›å»ºçš„ï¼Œæ‰€ä»¥å¦‚æœä¸€ä¸ªäº‹ä»¶ä¸­æ‰§è¡Œäº† e.stopPropagation ï¼Œé‚£ä¹ˆäº‹ä»¶æºä¸­å°±èƒ½æ„ŸçŸ¥å¾—åˆ°ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡ event.isPropagationStopped æ¥åˆ¤æ–­æ˜¯å¦é˜»æ­¢å†’æ³¡ï¼Œå¦‚æœç»„ç»‡ï¼Œé‚£ä¹ˆå°±ä¼šé€€å‡ºï¼Œè¿™æ ·å°±æ¨¡æ‹Ÿäº†äº‹ä»¶æµçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä»¥åŠé˜»æ­¢äº‹ä»¶å†’æ³¡ã€‚

## å›› æ€»ç»“

ä»¥ä¸Šå°±æ˜¯æ–°ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿçš„åŸç†ï¼Œè¿™é‡Œç”¨ä¸€å¹…å›¾æ¥æ€»ç»“ï¼Œæ–°è€ç‰ˆæœ¬äº‹ä»¶ç³»ç»Ÿåœ¨æ¯ä¸ªé˜¶æ®µçš„åŒºåˆ«ã€‚

![8-6-3.png](./images/6f893c626a7048bd95c7a02046f3a047~tplv-k3u1fbpfcp-watermark.image.png)