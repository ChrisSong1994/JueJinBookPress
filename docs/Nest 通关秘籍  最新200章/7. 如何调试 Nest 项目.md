# 7. 如何调试 Nest 项目

不少同学都是用 console.log 调试的，哪怕工作很多年依然是这样，这样有个致命的缺点：

你只能看到某个点的变量值，而看不到代码的整个执行路线。

对于复杂的项目来说，会用断点调试是必须的，因为这样可以看到作用域、调用栈，也就是代码的执行路线，然后单步运行来看变量的变化。

![](./images/2e5faa9d2b433184e311058984e28645.png )

所以这一节我们来学下如何调试 nest 项目。

首先，先看下 node 调试：

创建个项目：

```
mkdir debug-test
cd debug-test
npm init -y
```

![](./images/60746bf083e260632b87592facdd04a5.png )

添加 index.js

```javascript
const os = require('os');

const homedir = os.homedir();

console.log(homedir);
```

通过 os 模块拿到了 home 目录的路径。

直接 node 执行会输出结果：

![](./images/fd612eaa31056d2049a9b72056993287.png )

我们以调试模式跑起来：
```
node --inspect-brk index.js
```
![](./images/08221a7f5e64b80751f593ad8c2d3a7c.png )

\--inspect 是调试模式运行，而 --inspect-brk 还会在首行断住。

可以看到，它起了一个 ws 服务。

然后我们用调试客户端连上它，比如用 Chrome DevTools。

打开 <chrome://inspect/>，可以看到可以调试的目标：

![](./images/3fd6084a096fcb6ddb43fb556eef1df0.png )

如果没有，就配置下 network target，加上 localhost:9229

![](./images/89947cf0234242d3ff688340c4581777.png )

点击 inspect 就可以看到调试界面了：

![](./images/e5ae1fec442c97445bc4206a7303a5a0.png )

代码在首行断住了，右侧也可以看到作用域和调用栈。

可以单步调试：

![](./images/24c9293dd0f177e813e62c5db02e7335.png )

nest 也是 node 项目，自然也是这样来调试的。

nest start 有个 --debug 的选项，

![](./images/da5d890f911e807158471bed0d7e87ba.png )

原理就是 node --inspect。

这时候 inspect 发现啥也没：

![](./images/842f032d4338bb2c9b4a6c961d83f05f.png )

因为 --inspect 并不会和 --inspect-brk 一样在首行断住。

我们在 controller 里加个 debugger：

![](./images/90fad1ec0598d5cadd92dd508b8d7a02.png )

然后访问下 <http://localhost:3000>

这时候你会发现代码在断点处断住了：

![](./images/c9625d7d6125f3c7f87a3cc54e5c7315.png )

可以看到代码的整个执行路线：

![](./images/f6cf1efbcf9883856e65e5eb7dbca1a7.png )

这样，就可以调试 nest 项目了。

但是这样调试还是太麻烦，我们一般在 VSCode 里写代码，能不能直接在 VSCode 里边写代码边调试呢？

当然是可以的。

VSCode 也实现了 Debugger 的客户端。

点击调试面板的 create launch.json file，它会创建 .vscode/launch.json 的调试配置文件：

![](./images/b39d2c1c360e6a9ec883c01b56c78b49.png )

![](./images/6b12e830b431aae68007cf1d6e973b69.png )

然后输入 node，快速创建一个 node 调试配置：

![](./images/8dd6440301e6e1d57def753fb9e256dd.png )

我们先调试下前面那个 index.js 文件：

![](./images/233cbe9112217c08be7f814447ec4e40.png )

stopOnEntry 是在首行断住，和 --inspect-brk 一样的效果。

![](./images/86bfb8dd218ade638a04a75292bc9622.png )

这样，就可以在 vscode 里调试 node 代码了。

在 vscode 里调试代码，最爽的是可以边改代码边调试。

比如你调试的过程中修改了代码，然后点击重新调试，就可以马上看到改动之后的效果：

![](./images/2e58b44a7063e887fdc4671abeaff67b.png )

调试体验就很棒！

nest 自然也可以这样调试：

还是 nest start --debug 来启动 nest 服务：

![](./images/0b3bdb167b44db5fb2652f8b825fb9a4.png )

添加一个 attach 类型的调试配置：

![](./images/3ada2f42cfac7a8c58bdf006a8e6f25b.png )

![](./images/500589c3612b88ae3a079ff67bfc47f5.png )

然后在 controller 里打个断点，访问 <http://localhost:3000>

![](./images/940e666110553376012c62fd7861fa11.png )

代码同样会在断点处断住。

这样就可以直接在 vscode 里打断点了。

不过如果是用 VSCode 调试，可以不用 nest start --debug，有更简便的方式：

![](./images/bed51c5c50694c8d4cc1c20de5ca32c2.png )

创建 npm scripts 的调试配置：

（如果创建出的调试配置 type 是 pwa-node 也可以，和 node 类型差不多，据说 pwa-node 功能多一点）

```json
{
    "type": "node",
    "request": "launch",
    "name": "debug nest",
    "runtimeExecutable": "npm",
    "args": [
        "run",
        "start:dev",
    ],
    "skipFiles": [
        "<node_internals>/**"
    ],
    "console": "integratedTerminal",
}
```

和我们命令行执行 npm run start:dev 一样。

![](./images/39f5c7bfd13885d01aa6eaff91a7e042.png )

这里的 runtimeExecutable 代表执行什么命令，args 传参数。

要指定 console 为 integratedTerminal，也就是用 vscode 的内置终端来打印日志，不然默认会用 debug console 跑，那个没有颜色：

![](./images/a522264501a97717626c52c79ecd6992.png )

点击调试模式启动：

![](./images/13a70cdf7ab1522d4d34510669bb4a1d.png )

然后浏览器访问 <http://localhost:3000>

![](./images/07171a01ffbf4cd844eeec378c68e135.png )

代码同样会在断点处断住。

这是最方便的调试 nest 项目的方式。

最后，介绍几种断点的类型，也是挺常用的：

有的时候只想打印日志，不想断住，又不想加 console.log 污染代码，这时候可以用 logpoint：

![](./images/e84115aaeeb514802a31a6d8cd06248d.png )

右键选择 logpoint：

![](./images/93d526a5ddc35c2398608d4b4a88bc6e.png )

输入打印的信息，变量用 {} 包裹。

代码执行到这里就会打印：

![](./images/b4a80aa03b88b2969852ea21f0295d8c.png )

这样适合不需要断住，但想打印日志的情况。不用在代码里加 console.log。

再就是条件断点：

![](./images/a6ee67478c6138f94c936e200da471a8.png )

![](./images/cc489fbe4a546780372d14617dbc7975.png )

表达式成立才会断住。

再就是异常断点，可以在没有处理的异常处自动断住：

![](./images/de9be29f9bfa64417e07b69bf0da8a16.png )

这些断点类型只要有个印象，用到的时候能想起来就行。

## 总结

复杂的代码需要用断点调试查看调用栈和作用域，也就是代码的执行路线，然后单步执行。

node 代码可以加上 --inspect 或者 --inspect-brk 启动调试 ws 服务，然后用 Chrome DevTools 或者 vscode debugger 连上来调试。

nest 项目的调试也是 node 调试，可以使用 nest start --debug 启动 ws 服务，然后在 vscode 里 attach 上来调试，也可以添加个调试配置来运行 npm run start:dev。

nest 项目最方便的调试方式还是在 VSCode 里添加 npm run start:dev 的调试配置。

此外，我们还理解了 logpoint、条件断点、异常断点等断点类型。

学会了 nest 项目的调试，就可以直接在代码里打断点了。
