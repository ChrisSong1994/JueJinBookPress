# 42.Charles 全功能速通（下）

上节学了常用的代理功能，这节我们来学其他的 charles 功能：

## DNS Spoofing

在本地准备一个 index.html，然后 npx http-server . 来跑一个静态服务器：

![](./images/03fa9c608ed2449f2254c869a4f9054a.webp )

浏览器访问下：

![](./images/1e3048a4ee8f11dcf7e699eb56d40f5b.webp )

执行 sudo vim /etc/hosts 修改 hosts 文件，添加一条 www.guangguangtest.com 到 127.0.0.1 的映射：

![](./images/0604489822fabce2a736b2861f1ae163.webp )

之后就可以用这个域名来访问了：

![](./images/86e04e7220220d2958b41767dea9317b.webp )

（如果你把科学上网的工具设置为系统代理，hosts 可能就不生效了，关掉即可）

除了浏览器，在 Terminal 也是可以通过 curl 访问的：

![](./images/3bcc769808a7bf2f2d5dbbace6925a67.webp )

ping 也能 ping 通：

![](./images/e64767f6c468fc6f0a4bdf88039d0265.webp )

charles 也有这个功能，叫做 DNS Spoofing（DNS 欺骗），在 Tools > DNS Spoofing 开启：

![](./images/4adce866073ec9da6873395a9d134d37.webp )

它的功能和 hosts 类似：

![](./images/cf0e725ef71482915f5ea46ddf9f2cfa.webp )

比如我配置了 www.guangguangtest2.com 的域名到 127.0.0.1 的映射，之后就可以浏览器访问这个域名了：

![](./images/bb9cdb9d8b8d7e840fdee3695fc494ea.webp )

但在 Terminal 还不行：

![](./images/c2e96c952a04d2ce7bcd3e025d9d4e58.webp )

为什么呢？

因为 DNS Spoofing 生效的前提是走了 charles 代理呀！

在浏览器里可以通过 SwitchyOmega 的插件切换代理，那命令行里怎么切换呢？

可以通过设置这个环境变量：

```
export https_proxy=http://127.0.0.1:8888 http_proxy=http://127.0.0.1:8888
```

设置之后执行 echo $https_proxy 就可以看到它的值：

![](./images/3bb67d31311f6096e368986cb76f29e7.webp )

这个端口就是 charles 代理服务的端口，可以在 Proxy > Proxy Settings 里设置：

![](./images/006e6a8a4563b6fcad719f4d1f52f97b.webp )

之后在命令行里的 http、https 请求，也会走 charles 代理：

![](./images/d08b1bfcbdad226fa7527820b26efcdd.webp )

curl 可以走代理，但是 ping 不会：

![](./images/d96e89afdc862e35f08002b398540071.webp )

因为 charles 只有 http、https 请求会走 charles 代理，这是和配置 hosts 的区别。

那如果不想用代理了，怎么取消呢？

通过 unset 去掉这个环境变量即可：

![](./images/c16ada834899a68a639c49fbc2f3a935.webp )

这就是 DNS Spoofing 功能，相比改 hosts 更便捷一些。

## Client Process

charles 可以展示发送 http 请求的 url。

在 Tools > Client Process Settings 开启：

![](./images/b8f058f15e9c971c62b30d753313f1a4.webp )

开启之后可以在 notes 看到发送请求的客户端进程：

![](./images/f9aa1860225ea535e4e172810ae5cb05.webp )

这个 google chrome helper 就是网页的一个渲染进程：

在进程管理器里也可以看到：

![](./images/cab7ca9604ab8eaee44b054d9d3a0be0.webp )

在终端设置为 charles 代理之后，之后的 http 请求也会被 charles 捕获到：

![](./images/d38b989cdfa9d5d0b8be7fd8134a9ca2.webp )

这时候也可以看到对应的客户端进程：

![](./images/3b520bef545a0df2831f5356581b8197.webp )

我们主要是调试网页用，所以这个功能倒是用的不多。

## Compose

能不能用 charles 手动发送请求呢？就像 postman 那样。

可以的，这就是 compose 功能。

点击 Tools > Compose New，创建一个 www.guangguangtest.com:8081 的请求：

![](./images/b9e9983bae166643ec556213491856b3.webp )

然后编辑请求的内容，可以修改 header、body 等：

![](./images/295f01424cbafc2910ee9b8e8e761919.webp )

点击 execute 来发送请求，就可以看到刚才这个请求的响应了：

![](./images/d53009bf7e825608419520a4ceaa8b13.webp )

我们再来构造个 post 请求，修改 header、query、body 等：

![](./images/053bfc712c4b62d0e75b7f276587977f.webp )

点击 execute 就可以看到这个 post 请求了：

![](./images/edef495b9bf37268920f04da6f74f8cb.webp )

除了创建新的请求外，也可以直接修改已有的请求，也就是 compose：

![](./images/61bd4bd0ccc5f9e3e5f5ce23c36093b6.webp )

这里变成钢笔就代表在 compose 中：

![](./images/9d1402c39c38efb2a2c3c89e25b71157.webp )

修改完点击 execute 就可以发送请求，也可以点击 cancle 来取消 compose。

## Repeat

可以 Tools > Repeat 或者右键请求然后点 Repeat 来重发请求：

![](./images/7840023d06829c6f7c28b731c80f5d18.webp )

如果想重发 n 次呢？这可以用高级 repeat 功能。

在 Tools > Advanced Repeat 里开启：

![](./images/fb31128be9b94febc9ae6c3785c99710.webp )

比如重复 10 次、两个并发，重复间隔为 1000ms，在新的 session 里展示结果。

效果是这样的：

![](./images/a29bd3226ba0439f847474c94d3da916.webp )

可以用来测试接口。

## Throttle

这个是模拟慢速的请求用的，点击这个乌龟的图标开启：

![](./images/71fe9347ebc97ea824b612136ebcc546.webp )

或者在 Proxy > Start Throttling 开启。

当然，一般我们只需要对某些域名开启 throttle，可以在 Proxy > Throttle Settings 里设置：

![](./images/6f34c4ba9436be15c06f140a158e293b.webp )

下面可以做更详细的速率设置。

## Web Interface

charles 也支持通过 web 网页来控制，在 Proxy > Web Interface Settings 里开启：

![](./images/e3cc06f68aa25fdb2dd98953eddbb039.webp )

可以支持匿名访问，也可以设置用户名和密码访问。

这这里可以做一些功能的开启和关闭：

![](./images/467f1d613f7f6db4e7a186da5200c80e.webp )

![](./images/554737e3cdae09d11888913291fa6525.webp )

有同学说，不是已经有客户端了么？

本地确实没啥必要用这个，但是远程控制的时候，就可以通过 web interface 了。

## Focused Hosts

charles 默认展示全部的 url：

![](./images/8983fd81513e3e2455d1d501582c8920.webp )

我们想找 juejin.cn 的请求的话可以过滤：

![](./images/8aa51e91683357fbc8a82faf012a696c.webp )

也可以通过 View > Focused Hosts 来设置关注的域名：

![](./images/fd2084b2d83193dc94f3bb44618a68ff.webp )

这样  charles 就会把其他的域名的请求折叠起来：

![](./images/d54d2acf65dafa0ee6413f7066768e96.webp )

也可以在请求上右键开启：

![](./images/7b669aaa2eee1342cfce3f8b484f395f.webp )

## Highlight Rules

还可以给不同的 url 指定不同的颜色。

在 View > Highlight Rules 开启：

![](./images/b6bdfe842596f49d296005f196550c43.webp )

效果如下：

![](./images/c4cd8592631120a6657fd9732ab16d38.webp )

更有用的是可以根据条件来高亮，比如我设置所有 Set-Cookie 的 header 不为空的响应都设置黄色。

![](./images/9b53ed7bad87d004ace541486068e032.webp )

![](./images/3f532c0aece43cba86da20ee17381543.webp )

这样所有响应有 Set-Cookie 的 header 的请求都高亮了：

![](./images/aa995369278fee6b93a65bcb3d98cdc3.webp )

和 Chrome DevTools 里的 has-response-header 过滤器类似：

![](./images/c4d6b677bb53e549fd749f02cfddb0d8.webp )

但是这个可以过滤的更多。

## find 

find 是搜索功能，可以在 session、选择的 url 或者某个 url 的请求里搜索。

在 Edit > Find 里开启：

![](./images/ede96ee153c60e63eaeed84cc1bec3d7.webp )

比如我选中 juejin.cn，然后在里面搜索 guang：

![](./images/8f8daec52b740a38d6372b9b87f030cf.webp )

右键有个 find in 功能，这个就是在某个 path 内搜索：

![](./images/c6907890911cbc3533760e25263fa4e5.webp )

还可以指定搜索 url/header/body。

## External Proxy

访问国外的网站需要科学上网，会起一个代理服务器，charles 抓包也要跑一个代理服务器。

但是我们网页只能指定代理服务器，那如何同时又能科学上网，又能 charles 抓包呢？

这就是 External Proxy 的功能了：

![](./images/a8b128a65ea7075d7265d6b5570ca7ae.webp )

可以在 Proxy > External Proxy Settings 设置转发的代理服务器，这样 charles 抓包之后会再转发给别的代理服务器。

还可以在 bypass 里设置白名单，这些 url 不走别的代理服务器。

## 总结

这节我们过了一遍 charles 的其他的功能：

- DNS Spoofing：DNS 欺骗，类似 hosts，但是只影响 http 和 https
- Client Process：展示发请求的进程名
- Compose：compose new 创建一个新的请求，compose 修改已有的请求
- Repeat：重发请求，可以设置重发次数、并发数、重发间隔
- Throttle：模拟慢速请求，可以做具体的速率设置
- Focus：只展示关注的 hosts 的请求，其余的折叠
- Highlight Rules：根据规则来高亮请求，使用不同的颜色
- Web Interface：通过 web 界面来控制一些功能的开启关闭，这适用于远程控制
- Find：在 session、path 等范围内根据关键词搜索
- External Proxy：charles 可以把请求转发给别的代理服务器，比如科学上网的

在调试网络请求的时候，这些都是挺有用的功能。






