# 38.如何用 Charles 断点调试 https 请求？

现在的网站基本都是 https 的，而 charles 是常用的 http 抓包工具，所以用 charles 调试 https 请求是常见的需求。

这节就来讲下如何用 charles 调试 https 请求，如何断点调试。

首先安装 charles，点击 start recording：

![](./images/d6066afcd1e5f02c57859e1b3b64ce28.webp )

浏览器访问一些页面，这时候左侧就会展示出抓到的 http/https 请求：

![](./images/a45219ef549c1b1c1b5bbe375e9e9c88.webp )

但是这时候抓到的是加密过后的内容，这是 https 的机制导致的：

![](./images/a87ca02d5b666b1bbdf84e2c1607d00f.webp )

服务端会下发被 CA 认证过的证书，里面包含了公钥，而服务器自己保留私钥，通过这种机制完成对称密钥的传输和身份的认证，之后加密传输数据。

中间人拿到的数据自然都是被加密过的，也就是上图的那些乱码：

![](./images/951e575e9e5a834c6e466148b0ff0a33.webp )

那抓包工具怎么能拿到明文的数据呢？

自己用服务端的证书和服务端对接不就行了？

也就是这样：

![](./images/0d98c7428a87de455c36ecfb1b195bc3.webp )

Charles 自己用服务端的证书来和服务端通信，然后给浏览器一个自己的证书，这样就能解密传输的内容，拿到明文数据了。

点击 Proxy 的 SSL Proxy Setting：

![](./images/9ce765b74a84368debfd520e28ebeead.webp )

添加一条对 juejin 的 https 代理：

![](./images/e75113e528c7a88b1d636bcc95212624.webp )

这是 juejin 之前的证书：

![](./images/440d57643f7f53e341c184f829b506e0.webp )

代理之后就换成了 Charles 的证书，但是会提示不安全：

![](./images/c57ad7645844b1a3a7a445d80f907a48.webp )

![](./images/934ade60a1f2694fbd10672af488c58b.webp )

这是因为系统有一个存放所有根证书的地方，要那里存在并且被信任的证书才是安全的。

点击 help > SSL Proxying > Install Charles Root Certificate，安装到系统的钥匙串中：

![](./images/4af2809ac413377d60483985220d1d8f.webp )

改为始终信任：

![](./images/07faee93a18050ee22be8e2674a865d3.webp )

这时候浏览器里就会标记安全了：

![](./images/dde8b23fc5817292541102d21b85c521.webp )

并且在 charles 里就会看到明文的 https 请求和响应内容：

![](./images/bb6a04b10bee291f1f4b7aa97a5753be.webp )

这个过程的原理就是这张图：

![](./images/df79fb4ee9a8bb4ad2305a730f6415c0.webp )

现在能够抓 https 包了，但是还不够，现在只能看，很多情况下我们是希望能修改一下请求和响应内容的，这时候就要用断点功能了：

右键请求，勾选 breakpoints：

![](./images/abeadfa62dfb4e325c4990f1518caf11.webp )

然后开启断点：

![](./images/e86f05a37d2b5c284e0fb3b962ee377f.webp )

刷新页面你会发现它断住了：

![](./images/4ff2788978e41b595485126be3427f35.webp )

下面三个按钮分别是取消、终止、执行修改后的请求的意思。

上面可以改 url，添加 header，还可以改请求内容和 cookie：

![](./images/a00959e1ba1b5b501864aada59040959.webp )

点击 execute 之后就会发送请求。

之后响应的时候还会断住，这时候就可以用同样的方式修改响应了：

![](./images/352c85a085b81b52d281096f02aa2c75.webp )

比如我把 title 修改了一下，点击 execute 之后，看到的网页就是修改过后的：

![](./images/82bbe442f36b68cf0f9a98e2ef6c8d69.webp )

这样我们就可以断点调试 https 请求了。

为什么可以实现断点功能呢？

这个很容易想明白，怎么请求、怎么响应都是 Charles 控制的，那想实现一个断点和编辑的功能，岂不是很容易么？

有的同学可能会问，移动端怎么调试呢？

其实是一样的，只不过移动端也要把 Charles 证书安装到自己的系统中，需要点击安装 charles 证书到移动设备：

![](./images/96f2d6f4a227272a19254aa07f374782.webp )

他会提示你在手机设置代理服务器，然后下载 Charles 证书：

![](./images/2e7abb9e20e02d19f645e9764e7e2bbd.webp )

原理和我们在 PC 端下载 Charles 证书是一样的，后续流程也一样。

除此以外，chrome 还有一个浏览器插件可以更细粒度的控制代理，叫做 SwitchyOmega：

![](./images/cc5d7d60f723cf02f89a59da1d99bb97.webp )

你可以配置若干个代理服务器，比如 charles 的代理服务器：

![](./images/d69bc600a4afc0fba734bb1cf6cec328.webp )

这个可以在 Charles 的 Proxy > Proxy Setting 里配置：

![](./images/3cbe0bb4a340d8e692b91f61b1562159.webp )

然后就可以配置什么 url 用什么代理，或者不用代理直接连接：

![](./images/2a86ae9589c1244b9226d777c42329b8.webp )

当你有多个代理服务器，或者想控制有的页面走代理有的不走的时候，就可以用这个插件来控制了。

要让你配置的规则生效，这里要选择 auto switch，也就是根据规则自动切换：

![](./images/4df2b6e2e14fbfdb99e75c6e6a90353e.webp )

这几个选项的意思分别是：

- 直接连接：不走代理
- 系统代理：用系统级别的代理配置
- proxy：这个是我们配置的那个代理服务器，可以指定网页走这个代理
- auto switch：根据规则自动切换代理

也可以为这个 url 单独设置代理方式：

![](./images/069dd3981637f713cd355d2ca22c2bce.webp )

## 总结

用 Charles 调试 https 请求是常见的需求，它需要安装 Charles 的证书到本地系统，然后信任，之后就可以抓到明文数据了。

原理就是 Charles 会使用服务器的证书来和服务器通信，然后发一个自己的证书给浏览器。

Charles 还有断点调试功能，可以修改请求和响应的数据。

移动端 https 调试也是同样的原理，只不过需要配置下代理和证书。

如果想切换代理服务器或者设置有的页面不走代理，可以用 Chrome 插件 SwitchyOmega 来控制。

会断点调试 https 请求还是很有意义的，比如改改 header、改改 body，看看会有啥效果，使用场景有很多。

